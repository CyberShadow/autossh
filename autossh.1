.\"  -*- nroff -*-
.\"
.\" Author: Carson Harding
.\" Copyright (c) 2002 Carson Harding. All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
.\" IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
.\" OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
.\" IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
.\" INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
.\" NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
.\" DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
.\" THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
.\" (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
.\" THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
.\"
.\" $Id: autossh.1,v 1.3 2002/05/08 02:46:45 harding Exp $
.\"
.Dd May 6, 2002
.Dt AUTOSSH 1
.Os
.Sh NAME
.Nm autossh
.Nd monitor and restart ssh sessions
.Sh SYNOPSIS
.Nm autossh
.Op Fl M Ar port
.Ar [SSH_OPTIONS]
.Sh DESCRIPTION
.Nm
is a program to start a copy of ssh and monitor it, restarting
it as necessary should it die or stop passing traffic.
.Pp
The original idea and the mechanism were from rstunnel (Reliable SSH
Tunnel). With this version of
.Nm
the method changes: 
.Nm
uses ssh to
construct a loop of ssh forwardings (one from local to remote, one
from remote to local), and then sends test data that it expects to
get back. (The idea is thanks to Terrence Martin.)
.Pp
.Sh CONTROLLING SSH
.Pp
.Ss SSH exits
.Pp
.Bl -tag -width Ds
.Nm
tries to distinguish the manner of death of the ssh process it
is monitoring and act appropriately. The rules are:
.Bl -tag -width Ds
.It 1.
If the ssh process exited normally (for example, someone typed
"exit" in an interactive session), 
.Nm
exits rather than restarting;
.It 2.
If 
.Nm
itself receives a SIGTERM, SIGINT, or a SIGKILL
signal, it assumes that it was deliberately signalled, and exits
after killing the child ssh process;
.It 3.
Periodically (by default every 10 minutes), 
.Nm
attempts to pass traffic on the monitor forwarded port. If this fails, 
.Nm
will kill the child ssh process (if it is still running) and start a new one; 
.It 4.
If the child ssh process dies for any other reason, 
.Nm
will attempt to start a new one.
.El
.Pp
.Ss Startup behaviour
.Pp
If the ssh session fails with an exit status of 1 on the very first 
try, 
.Nm
.Bl -tag -width Ds
.It 1.
Will assume that there is some problem with syntax or the connection 
setup, and will exit rather than retrying;
.It 2.
There is now a "starting gate" time. If the first ssh process fails 
within the first few seconds of being started, 
.Nm
assumes that 
it never made it "out of the starting gate", and exits. This is to handle
initial failed authentication, connection, etc. This time is 30 seconds
by default, and can be adjusted (see the AUTOSSH_GATETIME environment
variable below).
.El
.Pp
.Ss Continued failures
.Pp
If the ssh connection fails and attempts to restart it fail in
quick succession, 
.Nm
will start delaying its attempts to
restart, gradually backing farther and farther off up to a
maximum interval of the 
.Nm
poll time (usually 10 minutes).
.Nm
can be "prodded" to retry by signalling it, perhaps with
SIGHUP ("kill -HUP").
.Pp
.Ss Connection setup
.Pp
As connections must be established unattended, the use of 
.Nm
requires that some form of automatic authentication be set up. The use
of RSAAuthentication with ssh-agent is the recommended method. The
example wrapper script attempts to check if there is an agent running
for the current environment, and to start one if there isn't.
.Pp
It cannot be stressed enough that you must make sure ssh works on its
own, that you can set up the session you want before you try to
run it under 
.Nm 
.
.Pp
If you are tunnelling and using an older version of ssh that does not
support the 
.Fl N
flag, you should upgrade (your version has security
flaws). If you can't upgrade, you may wish to do as rstunnel does, and
give ssh a command to run, such as "sleep 99999999999".
.Sh OPTIONS
.Bl -tag -width Ds
.It Fl M Ar port
specifies the base monitoring port to use. This port and the port
immediately above it (
.Ar port
+ 1) should be something nothing else is
using. 
.Nm 
will send test data on the base monitoring port, and
receive it back on the port above. For example, if you specify "-M
20000", 
.Nm
will set up forwards so that it can send data on port
20000 and receive it back on 20001.
.It Fl V 
causes 
.Nm 
to display its version and exit.
.Sh ENVIRONMENT
Other than the flag to set the connection monitoring port,
.Nm 
uses environment variables to control features. ssh seems to be 
still collecting letters for options, and this seems the easiest
way to avoid collisions.
.Bl -tag -width Ds
.It Ev AUTOSSH_PATH
Specifies the path to the ssh executable, in case it is 
different than the path compiled in.
.It Ev AUTOSSH_POLL
Specifies the connection poll time in seconds; default is 600 seconds.
.It Ev AUTOSSH_LOGLEVEL
Specifies the log level, corresponding to the levels 
used by syslog; so 0-7 with 7 being the
chattiest.
.It Ev AUTOSSH_LOGFILE
Specifies that
.Nm
should use the named log file, rather than syslog.
.It Ev AUTOSSH_DEBUG
If set this variable is set, the logging level is set to to LOG_DEBUG, 
and if the operating system supports
it, syslog is set to duplicate log entries to stderr.
.It Ev AUTOSSH_PORT
Sets the connection monitoring port. Mostly in case ssh
appropriates -M at some time. But because of this possible use, 
AUTOSSH_PORT overrides the -M flag.
.It Ev AUTOSSH_GATETIME
Specifies how long ssh must be up before we consider
it a successful connection. The default is 30 seconds.
.Sh AUTHOR
.Nm
was written by Carson Harding.
.Sh SEE ALSO
.Xr ssh 1 ,
.Xr ssh-add 1 ,
.Xr ssh-agent 1 ,
.Xr ssh-keygen 1 .
